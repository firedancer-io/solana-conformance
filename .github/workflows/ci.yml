name: CI

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build_and_test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout with submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake make g++ pkg-config gcc gdb

      - name: Install Rust (for rust-gdb)
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          components: rust-src
          override: true

      - name: Build vendored dependencies (flatc, buf)
        run: |
          ./deps.sh
          ./deps.sh --status

      - name: Create virtual environment and install
        run: |
          python -m venv test_suite_env
          source test_suite_env/bin/activate
          pip install --upgrade pip
          pip install -e ".[dev,octane]"

      - name: Generate Protobuf and FlatBuffers bindings
        run: |
          source test_suite_env/bin/activate
          ./fetch_and_generate.sh

      - name: Check dependencies
        run: |
          source test_suite_env/bin/activate
          solana-conformance check-deps

      - name: List harness types
        run: |
          source test_suite_env/bin/activate
          solana-conformance list-harness-types

      - name: Run FlatBuffers unit tests
        run: |
          source test_suite_env/bin/activate
          pytest tests/test_flatbuffers.py -v --tb=short

      - name: Run CLI unit tests
        run: |
          source test_suite_env/bin/activate
          pytest tests/ -v --tb=short --ignore=tests/test_integration.py -k "not requires_targets"

  # Separate job to lint shell scripts
  shellcheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install ShellCheck
        run: sudo apt-get install -y shellcheck

      - name: Lint shell scripts
        run: |
          shellcheck -x *.sh generators/*.sh || true
          echo "ShellCheck completed (warnings allowed for now)"

  # Test on RHEL-like system
  test-rhel:
    runs-on: ubuntu-latest
    container:
      image: rockylinux:8

    steps:
      - name: Install git
        run: |
          dnf install -y git

      - name: Checkout with submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install system dependencies
        run: |
          dnf install -y python3.11 python3.11-devel cmake make gcc-c++ gcc-toolset-12

      - name: Build vendored dependencies
        run: |
          source /opt/rh/gcc-toolset-12/enable
          ./deps.sh
          ./deps.sh --status

      - name: Create venv and install
        run: |
          python3.11 -m venv test_suite_env
          source test_suite_env/bin/activate
          pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Generate bindings and verify
        run: |
          source test_suite_env/bin/activate
          ./fetch_and_generate.sh
          solana-conformance check-deps
